sudo: required
dist: trusty
language: python
python:
- '3.6'
services:
- docker
before_install:
- nvm install node
install:
- pip install -r backend/requirements.txt
- pip install codeclimate-test-reporter
- pip install codacy-coverage
- pip install coveralls
- pip install codecov
script:
- cd frontend
- npm install
- npm run build
- npm run cover
- cat coverage/lcov.info | ./node_modules/.bin/codacy-coverage
- cat coverage/lcov.info | ./node_modules/coveralls/bin/coveralls.js
- cd ..
- export PYTHONPATH=$PYTHONPATH:backend
- coverage run --branch backend/tests/run_unittests.py discover -s backend/tests/unittests -p "*_tests.py"
- coverage xml
# Code climate is compatible with Coverage.py versions >=4.0,<4.4.
# Your Coverage.py report version is 4.4.1.
# Consider locking your version of Coverage.py to >4,0,<4.4 until the
# following Coverage.py issue is addressed:
# https://bitbucket.org/ned/coveragepy/issues/578/incomplete-file-path-in-xml-report
#- CODECLIMATE_REPO_TOKEN=58f7db7da1655acbe50dec6251772d4473dce782808e29b20299d5a7f3fca904
#  codeclimate-test-reporter --file build/.coverage
- python-codacy-coverage -r coverage.xml
- coveralls
- codecov
- coverage run --parallel-mode --branch backend/tests/run_integrationtests.py discover -s
  backend/tests/integrationtests -p "*_tests.py"
- coverage combine
- coverage xml --ignore-errors -o it-coverage.xml
- sonar-scanner -Dsonar.login=$SONAR_TOKEN
before_deploy:
- cd backend
- python setup.py bundle
deploy:
  provider: pypi
  user: fniessink
  skip_cleanup: true
  password:
    secure: FI9Q2kC5D6i2hjK7t0GTVzYIgmU7H9GoI0qqtzVtT6V7gfV74HtfPxuIbkF6HND09GY1moSF5I0vyR8Bm2nMxEs+9PflYtNUMeNlyrEEof/brbYIrKujPGr6wVdgT4iZlMAVeybRTWhPQpo5PFsGuGcQa5cZOzt4fPPy/KO8C0c=
  on:
    tags: true
after_deploy:
  - cd ..
  - docker build --no-cache -t ictu/quality-report .
  - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
  - docker push ictu/quality-report
addons:
  sonarcloud:
    organization: ictu
  code_climate:
    repo_token: 58f7db7da1655acbe50dec6251772d4473dce782808e29b20299d5a7f3fca904
env:
  global:
  - secure: mOpbXELefnD2snAx7ie+wQwcF52/ee1n1ILeqjnSunDGHCZzitpYwVR1+hhqXyK0bNy+HdALCXf2rlqzJUvOsQmAYefj19w4K5SzejVd27MVeJ15EFX9NAruRo0Z3qg1jr5s0argFra5JrdXbfGGLWqY7Ejj5ZzG40VlRjKMx88=
